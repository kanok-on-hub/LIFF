<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Leave Request</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900 pb-28">

<div class="max-w-md mx-auto">
  <div class="bg-white px-6 pt-10 pb-6 rounded-b-[2rem] shadow-sm sticky top-0 z-10">
    <div class="text-xl font-bold">Leave Request ğŸ“</div>
    <div id="userGreet" class="text-sm text-slate-500 mt-1">Loading...</div>
  </div>

  <div class="p-5 space-y-4">
    <div>
      <div class="text-sm font-bold mb-2">Leave Type *</div>
      <div class="grid grid-cols-2 gap-2">
        <button class="type-btn bg-white border rounded-xl p-3 text-left" onclick="selectType('Sick', this)">ğŸ¤’ Sick</button>
        <button class="type-btn bg-white border rounded-xl p-3 text-left" onclick="selectType('Annual', this)">ğŸ–ï¸ Annual</button>
        <button class="type-btn bg-white border rounded-xl p-3 text-left" onclick="selectType('Personal', this)">ğŸš— Personal</button>
        <button class="type-btn bg-white border rounded-xl p-3 text-left" onclick="selectType('Other', this)">ğŸ“ Other</button>
      </div>
      <input id="leaveType" type="hidden" value="">
    </div>

    <div id="otherBox" class="hidden">
      <div class="text-sm font-bold mb-2 text-blue-700">Specify Other *</div>
      <input id="otherSpecify" class="w-full border rounded-xl p-3" placeholder="e.g. Ordination">
    </div>

    <div class="bg-white border rounded-2xl p-4 space-y-2">
      <div class="text-sm font-bold">Dates *</div>
      <div class="grid grid-cols-2 gap-2">
        <input id="startDate" type="date" class="w-full border rounded-xl p-3 text-center" onchange="validateOnFly()">
        <input id="endDate" type="date" class="w-full border rounded-xl p-3 text-center" onchange="validateOnFly()">
      </div>
      <div id="dayCount" class="text-xs text-blue-700 font-bold hidden"></div>
      <div class="text-[11px] text-slate-400 italic">* Weekends & Company Holidays excluded.</div>
    </div>

    <div class="bg-white border rounded-2xl p-4">
      <div class="text-sm font-bold mb-2">Duration *</div>
      <div class="flex bg-slate-100 p-1 rounded-xl">
        <button class="durBtn flex-1 py-2 rounded-lg bg-white font-bold text-blue-700" onclick="selectDur('Full Day', this)">Full Day</button>
        <button class="durBtn flex-1 py-2 rounded-lg text-slate-500" onclick="selectDur('Morning', this)">Morning</button>
        <button class="durBtn flex-1 py-2 rounded-lg text-slate-500" onclick="selectDur('Afternoon', this)">Afternoon</button>
      </div>
      <input id="duration" type="hidden" value="Full Day">
    </div>

    <div>
      <div class="text-sm font-bold mb-2">Reason *</div>
      <textarea id="reason" class="w-full border rounded-2xl p-3" rows="3" oninput="validateOnFly()" placeholder="Please specify reason..."></textarea>
    </div>

    <div id="fileCard" class="bg-white border-2 border-dashed rounded-2xl p-4 cursor-pointer" onclick="document.getElementById('file').click()">
      <div class="font-bold text-sm" id="fileTitle">Attachment (Optional)</div>
      <div class="text-xs text-slate-400" id="fileHint">Required if Sick Leave â‰¥ 3 working days</div>
      <input id="file" type="file" class="hidden" accept="image/*,application/pdf" onchange="handleFileChange(this)">
    </div>
  </div>

  <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
    <button class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold" onclick="handleSubmit()">Submit</button>
  </div>
</div>

<div id="loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm hidden items-center justify-center">
  <div class="text-center">
    <div class="w-10 h-10 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-3"></div>
    <div class="font-bold text-slate-600">Submitting...</div>
  </div>
</div>

<script>
  // ====== SET THESE 3 VALUES ONLY ======
  const LIFF_ID = "2008997153-OdZGJzVg";
  const API_URL = "https://script.google.com/macros/s/AKfycby9WkktTkhrTLrtCYdNVDuedfewbuWgAkR5v3oV2u2a9htVhzyZzf2Ihdu3yw8sFk32qQ/exec";
  const SUCCESS_URL = "success.html";
  // ====================================

  let companyHolidays = [];
  let userProfile = null;

  function setLoading(on) {
    const el = document.getElementById("loader");
    el.classList.toggle("hidden", !on);
    el.classList.toggle("flex", on);
  }

  function selectType(val, btn) {
    document.querySelectorAll(".type-btn").forEach(b => b.classList.remove("ring-2","ring-blue-500"));
    btn.classList.add("ring-2","ring-blue-500");
    document.getElementById("leaveType").value = val;

    const otherBox = document.getElementById("otherBox");
    if (val === "Other") otherBox.classList.remove("hidden");
    else { otherBox.classList.add("hidden"); document.getElementById("otherSpecify").value = ""; }

    validateOnFly();
  }

  function selectDur(val, btn) {
    document.querySelectorAll(".durBtn").forEach(b => {
      b.classList.remove("bg-white","font-bold","text-blue-700");
      b.classList.add("text-slate-500");
    });
    btn.classList.add("bg-white","font-bold","text-blue-700");
    btn.classList.remove("text-slate-500");
    document.getElementById("duration").value = val;
  }

  function handleFileChange(input) {
    const title = document.getElementById("fileTitle");
    if (input.files && input.files[0]) title.textContent = input.files[0].name;
    else title.textContent = "Attachment (Optional)";
    validateOnFly();
  }

  async function fetchHolidays() {
    try {
      const res = await fetch(`${API_URL}?action=get_holidays`);
      const data = await res.json();
      companyHolidays = Array.isArray(data) ? data : [];
    } catch (e) {
      companyHolidays = [];
    }
  }

  function calcWorkingDays(startStr, endStr) {
    const s = new Date(startStr);
    const e = new Date(endStr);
    if (isNaN(s.getTime()) || isNaN(e.getTime()) || s > e) return 0;

    let total = 0;
    let cur = new Date(s);
    while (cur <= e) {
      const day = cur.getDay();
      const iso = cur.toISOString().split("T")[0];
      const isWeekend = (day === 0 || day === 6);
      const isHoliday = companyHolidays.includes(iso);
      if (!isWeekend && !isHoliday) total++;
      cur.setDate(cur.getDate() + 1);
    }
    return total;
  }

  function validateOnFly() {
    const type = document.getElementById("leaveType").value;
    const s = document.getElementById("startDate").value;
    const e = document.getElementById("endDate").value;

    if (!s || !e) return true;

    const days = calcWorkingDays(s, e);
    const badge = document.getElementById("dayCount");
    badge.textContent = `${days} Working Days`;
    badge.classList.remove("hidden");

    const file = document.getElementById("file").files[0];
    const fileCard = document.getElementById("fileCard");
    const fileTitle = document.getElementById("fileTitle");

    // rule: Sick >= 3 working days requires attachment
    if (type === "Sick" && days >= 3 && !file) {
      fileCard.classList.add("border-red-500");
      fileTitle.textContent = "Medical Cert. Required! *";
      return false;
    } else {
      fileCard.classList.remove("border-red-500");
      return true;
    }
  }

  function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      if (!file) return resolve("");
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function handleSubmit() {
    const leaveType = document.getElementById("leaveType").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const duration = document.getElementById("duration").value;
    const reason = document.getElementById("reason").value.trim();
    const otherSpecify = document.getElementById("otherSpecify").value.trim();

    if (!leaveType) return alert("Please select Leave Type");
    if (!startDate || !endDate) return alert("Please select dates");
    if (!reason) return alert("Please specify reason");
    if (leaveType === "Other" && !otherSpecify) return alert("Please specify Other type");
    if (!validateOnFly()) return alert("Medical Certificate required!");

    setLoading(true);

    try {
      const f = document.getElementById("file").files[0];
      let attachmentBase64 = "", attachmentMime = "", attachmentName = "";
      if (f) {
        if (f.size > 5 * 1024 * 1024) throw new Error("File size limit is 5MB");
        attachmentBase64 = await fileToDataUrl(f);
        attachmentMime = f.type || "";
        attachmentName = f.name || "";
      }

      const payload = {
        userId: userProfile?.userId || "guest",
        name: userProfile?.displayName || "Guest",
        leaveType,
        otherSpecify,
        startDate,
        endDate,
        dayPart: duration,
        reason,
        attachmentBase64,
        attachmentMime,
        attachmentName
      };

      // à¹ƒà¸Šà¹‰ text/plain à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸µà¹ˆà¸¢à¸‡ preflight à¸‡à¹ˆà¸²à¸¢ + à¸­à¹ˆà¸²à¸™à¸œà¸¥à¹„à¸”à¹‰
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Submit failed");

      const requestId = json.requestId || "";
      window.location.href = `${SUCCESS_URL}?ok=1&requestId=${encodeURIComponent(requestId)}`;
    } catch (e) {
      alert("âŒ Error: " + (e.message || e));
    } finally {
      setLoading(false);
    }
  }

  async function init() {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.href });
      return;
    }

    userProfile = await liff.getProfile();
    document.getElementById("userGreet").textContent = `Hi, ${userProfile.displayName}`;

    const today = new Date().toISOString().split("T")[0];
    document.getElementById("startDate").value = today;
    document.getElementById("endDate").value = today;

    await fetchHolidays();
    validateOnFly();
  }

  init().catch(err => {
    console.error(err);
    document.getElementById("userGreet").textContent = "Failed to init LIFF";
  });
</script>
</body>
</html>
